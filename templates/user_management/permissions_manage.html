{% extends 'base/base.html' %}
{% load static %}
{% load servicos_filters %}

{% block title %}Gerenciar Permissões - {{ user_obj.username }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/users.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}" class="text-decoration-none"><i class="bi bi-house-fill me-1"></i>Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'user_management:user_list' %}" class="text-decoration-none"><i class="bi bi-people-fill me-1"></i>Usuários</a></li>
            <li class="breadcrumb-item"><a href="{% url 'user_management:user_detail' user_obj.pk %}" class="text-decoration-none">{{ user_obj.username }}</a></li>
            <li class="breadcrumb-item active" aria-current="page"><i class="bi bi-shield-lock-fill me-1"></i>Permissões</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-white">
                            <i class="bi bi-shield-lock-fill me-2"></i>
                            <span class="text-white">Gerenciar Permissões: {{ user_obj.username }}</span>
                        </h5>
                        <a href="{% url 'user_management:user_detail' user_obj.pk %}" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Voltar
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if user_obj.is_superuser %}
                        <div class="alert alert-warning border-0" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Superusuário:</strong> Este usuário tem acesso total ao sistema e não pode ter suas permissões alteradas.
                        </div>
                    {% else %}
                        <form method="post" class="permissions-form">
                            {% csrf_token %}
                            
                            <!-- Hierarquia de Permissões -->
                            <div class="alert alert-info border-0 mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Hierarquia de Permissões:</strong> 
                                <span class="badge bg-success">Usuário</span> sobrescreve 
                                <span class="badge bg-warning">Grupo</span>
                            </div>
                            
                            <!-- Grupos de Usuário e Presets -->
                            <div class="row mb-4 g-4">
                                <div class="col-12 col-lg-8">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-header bg-white border-bottom py-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1 fw-bold"><i class="bi bi-people-fill me-2 text-primary"></i>Grupos de Usuário</h6>
                                                    <small class="text-muted">Selecione grupos para herdar permissões automaticamente</small>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-primary" onclick="selectAllGroups()" title="Marcar todos">
                                                        <i class="bi bi-check-all me-1"></i>Todos
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="clearAllGroups()" title="Limpar">
                                                        <i class="bi bi-x-circle me-1"></i>Limpar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-3">
                                            <div class="row g-3">
                                                {% for group in all_groups %}
                                                <div class="col-xl-4 col-md-6">
                                                    <label for="group_{{ group.id }}" class="group-select-card {% if group.id|stringformat:"s" in user_groups_ids %}active{% endif %}">
                                                        <input class="group-checkbox" 
                                                               type="checkbox" 
                                                               name="groups" 
                                                               value="{{ group.id }}" 
                                                               id="group_{{ group.id }}"
                                                               data-group-id="{{ group.id }}"
                                                               {% if group.id|stringformat:"s" in user_groups_ids %}checked{% endif %}>
                                                        <div class="group-select-card__content">
                                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                                <div class="group-select-card__title">{{ group.name }}</div>
                                                                <div class="group-select-card__check">
                                                                    <i class="bi bi-check-circle-fill"></i>
                                                                </div>
                                                            </div>
                                                            <div class="group-select-card__meta">
                                                                <i class="bi bi-key-fill me-1"></i>{{ group.permissions.count }} permissão{{ group.permissions.count|pluralize:"ões" }}
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-header bg-gradient-primary text-white py-3">
                                            <h6 class="mb-1 fw-bold"><i class="bi bi-lightning-charge-fill me-2"></i>Presets Rápidos</h6>
                                            <small class="opacity-75">Aplicar pacote de permissões</small>
                                        </div>
                                        <div class="card-body p-3">
                                            <div class="d-grid gap-2">
                                                {% for preset_name, perms in role_presets.items %}
                                                <button type="button" class="preset-btn" onclick="applyPreset('{{ preset_name }}')">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="fw-600">{{ preset_name }}</span>
                                                        <span class="badge bg-primary">{{ perms|length }}</span>
                                                    </div>
                                                </button>
                                                {% endfor %}
                                            </div>
                                            <div class="alert alert-info border-0 mt-3 mb-0 py-2 px-3">
                                                <small><i class="bi bi-info-circle me-1"></i>As permissões dos presets sobrescrevem grupos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <!-- Permissões -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-white border-bottom py-3">
                                            <h6 class="mb-0 fw-bold"><i class="bi bi-shield-lock-fill me-2 text-primary"></i>Permissões do Sistema</h6>
                                        </div>
                                        <div class="card-body p-0">
                                            {% for app_label, permissions in permissions_by_app.items %}
                                            <div class="app-section">
                                                <div class="app-section__header">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-0 fw-bold text-dark">{{ app_label|title }}</h6>
                                                            <small class="text-muted">{{ permissions|length }} permissão{{ permissions|length|pluralize:"ões" }} disponíve{{ permissions|length|pluralize:"l,is" }}</small>
                                                        </div>
                                                        <div class="btn-group btn-group-sm">
                                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleApp('{{ app_label }}', true)">
                                                                <i class="bi bi-check-all me-1"></i>Marcar
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleApp('{{ app_label }}', false)">
                                                                <i class="bi bi-x-circle me-1"></i>Limpar
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="app-section__content">
                                                    <div class="row g-3">
                                                        {% for permission in permissions %}
                                                        {% with source=permissions_with_source|get_item:permission.id %}
                                                        <div class="col-xl-3 col-lg-4 col-md-6">
                                                            <label for="perm_{{ permission.id }}" class="permission-card {% if permission.id|stringformat:"s" in user_permissions_ids or permission.id|stringformat:"s" in user_group_permissions_ids %}active{% endif %} {% if source.is_direct %}from-user{% elif source.is_from_group %}from-group{% endif %}" data-perm-id="{{ permission.id }}" data-perm-origin="{{ source.origin }}">
                                                                <input class="permission-checkbox" 
                                                                       type="checkbox" 
                                                                       name="user_permissions" 
                                                                       value="{{ permission.id }}" 
                                                                       id="perm_{{ permission.id }}"
                                                                       data-origin="{{ source.origin }}"
                                                                       data-app="{{ app_label }}"
                                                                       {% if permission.id|stringformat:"s" in user_permissions_ids or permission.id|stringformat:"s" in user_group_permissions_ids %}checked{% endif %}>
                                                                <div class="permission-card__content">
                                                                    <div class="permission-card__check">
                                                                        <i class="bi bi-check-circle-fill"></i>
                                                                    </div>
                                                                    <div class="permission-card__title">{{ permission.name }}</div>
                                                                    <div class="permission-card__code">{{ permission.codename }}</div>
                                                                    <div class="permission-card__badge">
                                                                        {% if source.is_direct %}
                                                                        <span class="badge bg-success"><i class="bi bi-person-fill me-1"></i>Usuário</span>
                                                                        {% elif source.is_from_group %}
                                                                        <span class="badge bg-warning"><i class="bi bi-people-fill me-1"></i>Grupo</span>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                        {% endwith %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Botões de Ação -->
                            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                <a href="{% url 'user_management:user_detail' user_obj.pk %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>Cancelar
                                </a>
                                
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" onclick="selectAllGroups()">
                                        <i class="bi bi-check-all me-1"></i>Marcar Todos os Grupos
                                    </button>
                                    <button type="button" class="btn btn-outline-warning me-2" onclick="clearAllSelections()">
                                        <i class="bi bi-x-circle me-1"></i>Limpar Tudo
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-shield-check me-1"></i>Salvar Permissões
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Objetos para armazenar permissões de grupos e presets
const groupPermissions = {
    {% for group in all_groups %}
    "{{ group.id }}": [{% for perm in group.permissions.all %}"{{ perm.id }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    {% endfor %}
};

const rolePresets = {
    {% for preset_name, perms in role_presets.items %}
    "{{ preset_name }}": [{% for pid in perms %}"{{ pid }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    {% endfor %}
};

// Ao marcar/desmarcar grupos, atualizar permissões e estilo das cards
document.querySelectorAll('.group-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const card = this.closest('.group-select-card');
        if (card) {
            card.classList.toggle('active', this.checked);
        }
        updatePermissionsFromGroups();
        updateCheckboxVisualFeedback();
    });
});

// Ao marcar/desmarcar permissões individuais, atualizar feedback visual
document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        this.dataset.groupAutocheck = '';
        updateCheckboxVisualFeedback();
    });
});

function updatePermissionsFromGroups() {
    // Coletar todas as permissões dos grupos selecionados
    const selectedGroupIds = Array.from(document.querySelectorAll('.group-checkbox:checked'))
        .map(cb => cb.getAttribute('data-group-id'));
    
    const groupPerms = new Set();
    selectedGroupIds.forEach(groupId => {
        if (groupPermissions[groupId]) {
            groupPermissions[groupId].forEach(permId => {
                groupPerms.add(permId);
            });
        }
    });
    
    // Atualizar checkboxes com visual de "Grupo"
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        const permId = checkbox.value;
        if (groupPerms.has(permId)) {
            if (!checkbox.checked) {
                checkbox.checked = true;
            }
            checkbox.dataset.groupAutocheck = 'true';
        } else {
            if (checkbox.dataset.groupAutocheck === 'true') {
                checkbox.checked = false;
                checkbox.dataset.groupAutocheck = '';
            }
        }
    });
}

function updateCheckboxVisualFeedback() {
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        const card = checkbox.closest('.permission-card');
        if (!card) return;
        card.classList.toggle('active', checkbox.checked);
    });
}

function toggleApp(appName, shouldCheck) {
    document.querySelectorAll(`.permission-checkbox[data-app="${appName}"]`).forEach(cb => {
        cb.checked = shouldCheck;
    });
    updateCheckboxVisualFeedback();
}

function applyPreset(presetName) {
    const perms = rolePresets[presetName] || [];
    if (!perms.length) return;
    const permSet = new Set(perms);
    document.querySelectorAll('.permission-checkbox').forEach(cb => {
        if (permSet.has(cb.value)) {
            cb.checked = true; // aplica como permissão do usuário
        }
    });
    updateCheckboxVisualFeedback();
}

// Funções auxiliares
function selectAllGroups() {
    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.checked = true;
        const card = checkbox.closest('.group-select-card');
        if (card) {
            card.classList.add('active');
        }
    });
    updatePermissionsFromGroups();
    updateCheckboxVisualFeedback();
}

function clearAllGroups() {
    document.querySelectorAll('.group-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        const card = checkbox.closest('.group-select-card');
        if (card) {
            card.classList.remove('active');
        }
    });
    updatePermissionsFromGroups();
    updateCheckboxVisualFeedback();
}

function clearAllSelections() {
    if (confirm('Tem certeza que deseja limpar todas as seleções?')) {
        document.querySelectorAll('.permissions-form input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateCheckboxVisualFeedback();
    }
}

// Confirmar mudanças importantes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.permissions-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const checkedGroups = document.querySelectorAll('.group-checkbox:checked').length;
            const checkedPermissions = document.querySelectorAll('.permission-checkbox:checked').length;
            
            const message = `Confirmar alterações de permissões:\n\n` +
                          `• ${checkedGroups} grupo(s) selecionado(s)\n` +
                          `• ${checkedPermissions} permissão(ões)\n\n` +
                          `Deseja continuar?`;
            
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
